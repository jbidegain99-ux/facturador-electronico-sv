generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id              String    @id @default(cuid())
  nombre          String
  nit             String    @unique
  nrc             String
  actividadEcon   String
  direccion       Json
  telefono        String
  correo          String
  nombreComercial String?
  certificatePath String?
  mhToken         String?
  mhTokenExpiry   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  usuarios        User[]
  dtes            DTE[]
  clientes        Cliente[]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nombre    String
  rol       Role     @default(FACTURADOR)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())

  @@index([tenantId])
}

enum Role {
  ADMIN
  CONTADOR
  FACTURADOR
}

model Cliente {
  id            String  @id @default(cuid())
  tenantId      String
  tenant        Tenant  @relation(fields: [tenantId], references: [id])
  tipoDocumento String
  numDocumento  String
  nombre        String
  nrc           String?
  correo        String?
  telefono      String?
  direccion     Json
  dtes          DTE[]

  @@unique([tenantId, numDocumento])
  @@index([tenantId])
}

model DTE {
  id               String    @id @default(cuid())
  tenantId         String
  tenant           Tenant    @relation(fields: [tenantId], references: [id])
  clienteId        String?
  cliente          Cliente?  @relation(fields: [clienteId], references: [id])
  tipoDte          String
  codigoGeneracion String    @unique
  numeroControl    String    @unique
  jsonOriginal     Json
  jsonFirmado      String?
  estado           DTEStatus @default(PENDIENTE)
  selloRecepcion   String?
  fechaRecepcion   DateTime?
  codigoMh         String?
  descripcionMh    String?
  totalGravada     Decimal   @db.Decimal(12, 2)
  totalIva         Decimal   @db.Decimal(12, 2)
  totalPagar       Decimal   @db.Decimal(12, 2)
  intentosEnvio    Int       @default(0)
  createdAt        DateTime  @default(now())
  logs             DTELog[]

  @@index([tenantId])
  @@index([estado])
  @@index([createdAt])
}

enum DTEStatus {
  PENDIENTE
  FIRMADO
  ENVIADO
  PROCESADO
  RECHAZADO
  ANULADO
}

model DTELog {
  id        String   @id @default(cuid())
  dteId     String
  dte       DTE      @relation(fields: [dteId], references: [id])
  accion    String
  request   Json?
  response  Json?
  error     String?
  createdAt DateTime @default(now())

  @@index([dteId])
}
