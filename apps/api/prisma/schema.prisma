generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model Tenant {
  id              String    @id @default(cuid())
  nombre          String
  nit             String    @unique
  nrc             String
  actividadEcon   String
  direccion       String    @db.NVarChar(Max)
  telefono        String
  correo          String
  nombreComercial String?
  certificatePath String?
  mhToken         String?   @db.NVarChar(Max)
  mhTokenExpiry   DateTime?

  // Branding
  logoUrl         String?
  primaryColor    String?   @default("#8b5cf6")

  // Suscripcion SaaS
  plan            String    @default("TRIAL")
  planStatus      String    @default("ACTIVE")
  planExpiry      DateTime?
  maxDtesPerMonth Int       @default(50)
  dtesUsedThisMonth Int     @default(0)
  monthResetDate  DateTime?

  // Notas admin
  adminNotes      String?   @db.NVarChar(Max)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  usuarios        User[]
  dtes            DTE[]
  clientes        Cliente[]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nombre    String
  rol       String   @default("FACTURADOR")
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdAt DateTime @default(now())

  @@index([tenantId])
}

model Cliente {
  id            String  @id @default(cuid())
  tenantId      String
  tenant        Tenant  @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tipoDocumento String
  numDocumento  String
  nombre        String
  nrc           String?
  correo        String?
  telefono      String?
  direccion     String  @db.NVarChar(Max)
  dtes          DTE[]

  @@unique([tenantId, numDocumento])
  @@index([tenantId])
}

model DTE {
  id               String    @id @default(cuid())
  tenantId         String
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  clienteId        String?
  cliente          Cliente?  @relation(fields: [clienteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tipoDte          String
  codigoGeneracion String    @unique
  numeroControl    String    @unique
  jsonOriginal     String    @db.NVarChar(Max)
  jsonFirmado      String?   @db.NVarChar(Max)
  estado           String    @default("PENDIENTE")
  selloRecepcion   String?
  fechaRecepcion   DateTime?
  codigoMh         String?
  descripcionMh    String?   @db.NVarChar(Max)
  totalGravada     Decimal   @db.Decimal(12, 2)
  totalIva         Decimal   @db.Decimal(12, 2)
  totalPagar       Decimal   @db.Decimal(12, 2)
  intentosEnvio    Int       @default(0)
  createdAt        DateTime  @default(now())
  logs             DTELog[]

  @@index([tenantId])
  @@index([estado])
  @@index([createdAt])
}

model DTELog {
  id        String   @id @default(cuid())
  dteId     String
  dte       DTE      @relation(fields: [dteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  accion    String
  request   String?  @db.NVarChar(Max)
  response  String?  @db.NVarChar(Max)
  error     String?  @db.NVarChar(Max)
  createdAt DateTime @default(now())

  @@index([dteId])
}
