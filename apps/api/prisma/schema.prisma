generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model Tenant {
  id              String    @id @default(cuid())
  nombre          String
  nit             String    @unique
  nrc             String
  actividadEcon   String
  direccion       String    @db.NVarChar(Max)
  telefono        String
  correo          String
  nombreComercial String?
  certificatePath String?
  mhToken         String?   @db.NVarChar(Max)
  mhTokenExpiry   DateTime?

  // Branding
  logoUrl         String?
  primaryColor    String?   @default("#8b5cf6")

  // Suscripcion SaaS
  plan            String    @default("TRIAL")
  planStatus      String    @default("ACTIVE")
  planExpiry      DateTime?
  maxDtesPerMonth Int       @default(50)
  dtesUsedThisMonth Int     @default(0)
  monthResetDate  DateTime?

  // Notas admin
  adminNotes      String?   @db.NVarChar(Max)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  usuarios        User[]
  dtes            DTE[]
  clientes        Cliente[]

  // Email & Onboarding relations
  emailConfig        TenantEmailConfig?
  emailConfigRequests EmailConfigRequest[]
  onboarding         TenantOnboarding?
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nombre    String
  rol       String   @default("FACTURADOR")
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdAt DateTime @default(now())

  @@index([tenantId])
}

model Cliente {
  id            String  @id @default(cuid())
  tenantId      String
  tenant        Tenant  @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tipoDocumento String
  numDocumento  String
  nombre        String
  nrc           String?
  correo        String?
  telefono      String?
  direccion     String  @db.NVarChar(Max)
  dtes          DTE[]

  @@unique([tenantId, numDocumento])
  @@index([tenantId])
}

model DTE {
  id               String    @id @default(cuid())
  tenantId         String
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  clienteId        String?
  cliente          Cliente?  @relation(fields: [clienteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tipoDte          String
  codigoGeneracion String    @unique
  numeroControl    String    @unique
  jsonOriginal     String    @db.NVarChar(Max)
  jsonFirmado      String?   @db.NVarChar(Max)
  estado           String    @default("PENDIENTE")
  selloRecepcion   String?
  fechaRecepcion   DateTime?
  codigoMh         String?
  descripcionMh    String?   @db.NVarChar(Max)
  totalGravada     Decimal   @db.Decimal(12, 2)
  totalIva         Decimal   @db.Decimal(12, 2)
  totalPagar       Decimal   @db.Decimal(12, 2)
  intentosEnvio    Int       @default(0)
  createdAt        DateTime  @default(now())
  logs             DTELog[]

  @@index([tenantId])
  @@index([estado])
  @@index([createdAt])
}

model DTELog {
  id        String   @id @default(cuid())
  dteId     String
  dte       DTE      @relation(fields: [dteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  accion    String
  request   String?  @db.NVarChar(Max)
  response  String?  @db.NVarChar(Max)
  error     String?  @db.NVarChar(Max)
  createdAt DateTime @default(now())

  @@index([dteId])
}

// ============================================================================
// EMAIL CONFIGURATION SYSTEM
// ============================================================================

// EmailProvider: SENDGRID, MAILGUN, AMAZON_SES, MICROSOFT_365, GOOGLE_WORKSPACE, POSTMARK, BREVO, MAILTRAP, SMTP_GENERIC
// EmailAuthMethod: API_KEY, SMTP_BASIC, OAUTH2, AWS_IAM
// ConfiguredBy: SELF, REPUBLICODE, PENDING
// HealthCheckType: CONNECTION_TEST, AUTHENTICATION_TEST, SEND_TEST, QUOTA_CHECK, OAUTH_REFRESH
// HealthStatus: HEALTHY, DEGRADED, UNHEALTHY, UNKNOWN
// EmailSendStatus: PENDING, SENT, DELIVERED, OPENED, BOUNCED, FAILED, SPAM_REPORTED
// EmailRequestType: NEW_SETUP, MIGRATION, CONFIGURATION_HELP, TROUBLESHOOTING
// RequestStatus: PENDING, IN_PROGRESS, WAITING_CLIENT, COMPLETED, CANCELLED
// MessageSender: TENANT, REPUBLICODE, SYSTEM

// Configuración principal de email del tenant
model TenantEmailConfig {
  id                String          @id @default(cuid())
  tenantId          String          @unique
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Proveedor y método
  provider          String          // EmailProvider
  authMethod        String          // EmailAuthMethod
  isActive          Boolean         @default(false)
  isVerified        Boolean         @default(false)

  // Configuración SMTP (encriptada)
  smtpHost          String?
  smtpPort          Int?
  smtpSecure        Boolean?        @default(true)
  smtpUser          String?
  smtpPassword      String?         @db.NVarChar(Max) // Encriptado en BD

  // Configuración API (encriptada)
  apiKey            String?         @db.NVarChar(Max) // Encriptado
  apiSecret         String?         @db.NVarChar(Max) // Encriptado
  apiEndpoint       String?

  // OAuth2 (para M365 y Google)
  oauth2ClientId     String?
  oauth2ClientSecret String?        @db.NVarChar(Max) // Encriptado
  oauth2TenantId     String?        // Para Azure AD
  oauth2RefreshToken String?        @db.NVarChar(Max) // Encriptado
  oauth2AccessToken  String?        @db.NVarChar(Max) // Encriptado
  oauth2TokenExpiry  DateTime?

  // Configuración de envío
  fromEmail         String
  fromName          String
  replyToEmail      String?

  // Configuración avanzada
  rateLimitPerHour  Int?            @default(100)
  retryAttempts     Int?            @default(3)
  timeoutSeconds    Int?            @default(30)

  // Metadatos
  configuredBy      String          @default("PENDING") // ConfiguredBy
  configuredByUserId String?
  notes             String?         @db.NVarChar(Max)

  // Auditoría
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  verifiedAt        DateTime?
  lastTestAt        DateTime?

  // Relaciones
  healthChecks      EmailHealthCheck[]
  sendLogs          EmailSendLog[]

  @@index([tenantId])
}

// Monitoreo de salud del servicio de email
model EmailHealthCheck {
  id              String            @id @default(cuid())
  configId        String
  config          TenantEmailConfig @relation(fields: [configId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  checkType       String            // HealthCheckType
  status          String            // HealthStatus
  responseTimeMs  Int?
  errorMessage    String?           @db.NVarChar(Max)
  errorCode       String?

  checkedAt       DateTime          @default(now())

  @@index([configId, checkedAt])
}

// Log de envíos de email
model EmailSendLog {
  id                String            @id @default(cuid())
  configId          String
  config            TenantEmailConfig @relation(fields: [configId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  dteId             String?           // Referencia al DTE enviado
  recipientEmail    String
  subject           String

  status            String            // EmailSendStatus
  providerMessageId String?
  errorMessage      String?           @db.NVarChar(Max)

  attemptNumber     Int               @default(1)
  sentAt            DateTime          @default(now())
  deliveredAt       DateTime?
  openedAt          DateTime?

  @@index([configId, sentAt])
  @@index([dteId])
}

// Solicitudes de servicio asistido
model EmailConfigRequest {
  id                String           @id @default(cuid())
  tenantId          String
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  requestType       String           // EmailRequestType
  desiredProvider   String?          // EmailProvider

  // Información proporcionada por el cliente
  currentProvider   String?
  accountEmail      String?
  additionalNotes   String?          @db.NVarChar(Max)

  // Estado del proceso
  status            String           @default("PENDING") // RequestStatus
  assignedTo        String?

  // Comunicación
  messages          EmailConfigMessage[]

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  completedAt       DateTime?

  @@index([tenantId])
  @@index([status])
}

model EmailConfigMessage {
  id              String             @id @default(cuid())
  requestId       String
  request         EmailConfigRequest @relation(fields: [requestId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  senderType      String             // MessageSender
  senderId        String?
  message         String             @db.NVarChar(Max)
  attachments     String?            @db.NVarChar(Max) // JSON array de URLs

  createdAt       DateTime           @default(now())

  @@index([requestId])
}

// ============================================================================
// ONBOARDING WIZARD SYSTEM - PROCESO DE REGISTRO CON HACIENDA
// ============================================================================

// OnboardingStep: WELCOME, COMPANY_INFO, HACIENDA_CREDENTIALS, DTE_TYPE_SELECTION, TEST_ENVIRONMENT_REQUEST, TEST_CERTIFICATE, API_CREDENTIALS_TEST, EXECUTE_TESTS, REQUEST_AUTHORIZATION, PROD_CERTIFICATE, API_CREDENTIALS_PROD, FINAL_VALIDATION, COMPLETED
// OnboardingStatus: NOT_STARTED, IN_PROGRESS, WAITING_HACIENDA, WAITING_CLIENT, BLOCKED, COMPLETED, CANCELLED
// AssistanceLevel: SELF_SERVICE, GUIDED, FULL_SERVICE
// DteType: FACTURA, CREDITO_FISCAL, NOTA_REMISION, NOTA_CREDITO, NOTA_DEBITO, COMPROBANTE_RETENCION, COMPROBANTE_LIQUIDACION, DOCUMENTO_CONTABLE_LIQUIDACION, FACTURA_EXPORTACION, FACTURA_SUJETO_EXCLUIDO, COMPROBANTE_DONACION
// StepStatus: PENDING, IN_PROGRESS, COMPLETED, SKIPPED, BLOCKED, FAILED
// PerformedBy: TENANT, REPUBLICODE, SYSTEM
// TestResult: SUCCESS, VALIDATION_ERROR, SIGNATURE_ERROR, TRANSMISSION_ERROR, OTHER_ERROR
// CommunicationType: EMAIL, IN_APP_MESSAGE, PHONE_CALL_LOG, MEETING_NOTES, SYSTEM_NOTIFICATION
// CommunicationDirection: TO_TENANT, FROM_TENANT, INTERNAL

// Proceso de onboarding del tenant
model TenantOnboarding {
  id                  String            @id @default(cuid())
  tenantId            String            @unique
  tenant              Tenant            @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Estado general
  currentStep         String            @default("WELCOME") // OnboardingStep
  overallStatus       String            @default("NOT_STARTED") // OnboardingStatus

  // Información del contribuyente (puede diferir del Tenant base)
  nit                 String?
  nrc                 String?
  razonSocial         String?
  nombreComercial     String?
  actividadEconomica  String?

  // Información de contacto Hacienda
  emailHacienda       String?           // Email registrado en Hacienda
  telefonoHacienda    String?

  // Credenciales MH (encriptadas)
  haciendaUser        String?
  haciendaPassword    String?           @db.NVarChar(Max) // Encriptado

  // Ambiente de pruebas
  testCertificate     String?           @db.NVarChar(Max) // Certificado de pruebas (base64)
  testCertPassword    String?           @db.NVarChar(Max) // Encriptado
  testCertExpiry      DateTime?
  testApiPassword     String?           @db.NVarChar(Max) // Encriptado
  testEnvironmentUrl  String?

  // Ambiente productivo
  prodCertificate     String?           @db.NVarChar(Max) // Certificado productivo (base64)
  prodCertPassword    String?           @db.NVarChar(Max) // Encriptado
  prodCertExpiry      DateTime?
  prodApiPassword     String?           @db.NVarChar(Max) // Encriptado
  prodEnvironmentUrl  String?

  // Fechas clave
  testAccessGrantedAt DateTime?
  testDeadline        DateTime?         // 60 días desde acceso
  authorizationDate   DateTime?
  productionDeadline  DateTime?         // 30 días desde autorización

  // Servicio asistido
  assistanceLevel     String            @default("GUIDED") // AssistanceLevel
  assignedAgent       String?

  // Auditoría
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  completedAt         DateTime?

  // Relaciones
  dteTypes            DteTypeSelection[]
  steps               OnboardingStepRecord[]
  testProgress        TestProgress?
  communications      OnboardingCommunication[]

  @@index([tenantId])
  @@index([currentStep])
  @@index([overallStatus])
}

// Tipos de DTE que el tenant quiere emitir
model DteTypeSelection {
  id              String           @id @default(cuid())
  onboardingId    String
  onboarding      TenantOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  dteType         String           // DteType
  isRequired      Boolean          @default(true)   // Algunos son obligatorios
  testCompleted   Boolean          @default(false)
  testCompletedAt DateTime?

  @@unique([onboardingId, dteType])
  @@index([onboardingId])
}

// Registro detallado de cada paso
model OnboardingStepRecord {
  id              String           @id @default(cuid())
  onboardingId    String
  onboarding      TenantOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  step            String           // OnboardingStep
  status          String           @default("PENDING") // StepStatus

  // Datos específicos del paso (JSON)
  stepData        String?          @db.NVarChar(Max) // JSON data

  // Notas y observaciones
  notes           String?          @db.NVarChar(Max)
  blockerReason   String?          @db.NVarChar(Max)

  // Quién realizó la acción
  performedBy     String?          // PerformedBy
  performedById   String?

  // Fechas
  startedAt       DateTime?
  completedAt     DateTime?

  @@unique([onboardingId, step])
  @@index([onboardingId])
}

// Progreso de pruebas técnicas
model TestProgress {
  id              String           @id @default(cuid())
  onboardingId    String           @unique
  onboarding      TenantOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Contadores de pruebas por tipo de DTE (JSON)
  testsRequired   String           @db.NVarChar(Max) // { "FACTURA": 5, "CREDITO_FISCAL": 3, ... }
  testsCompleted  String           @db.NVarChar(Max) // { "FACTURA": 5, "CREDITO_FISCAL": 2, ... }

  // Eventos requeridos (JSON)
  eventsRequired  String           @db.NVarChar(Max) // { "ANULACION": 2, "CONTINGENCIA": 1, ... }
  eventsCompleted String           @db.NVarChar(Max)

  lastTestAt      DateTime?
  lastTestResult  String?          // TestResult
  lastTestError   String?          @db.NVarChar(Max)

  @@index([onboardingId])
}

// Comunicaciones durante el onboarding
model OnboardingCommunication {
  id              String                 @id @default(cuid())
  onboardingId    String
  onboarding      TenantOnboarding       @relation(fields: [onboardingId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  type            String                 // CommunicationType
  direction       String                 // CommunicationDirection
  subject         String?
  content         String                 @db.NVarChar(Max)
  attachments     String?                @db.NVarChar(Max) // JSON array de URLs

  relatedStep     String?                // OnboardingStep

  sentBy          String?
  sentAt          DateTime               @default(now())
  readAt          DateTime?

  @@index([onboardingId])
}
