generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model Tenant {
  id              String    @id @default(cuid())
  nombre          String
  nit             String    @unique
  nrc             String
  actividadEcon   String
  direccion       String    @db.NVarChar(Max)
  telefono        String
  correo          String
  nombreComercial String?
  certificatePath String?
  mhToken         String?   @db.NVarChar(Max)
  mhTokenExpiry   DateTime?

  // Branding
  logoUrl         String?
  primaryColor    String?   @default("#8b5cf6")

  // Suscripcion SaaS
  plan            String    @default("TRIAL") // Codigo del plan (legacy, usar planId)
  planId          String?
  planRef         Plan?     @relation("TenantPlan", fields: [planId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  planStatus      String    @default("ACTIVE")
  planExpiry      DateTime?
  maxDtesPerMonth Int       @default(50)
  maxUsers        Int       @default(5)
  maxClientes     Int       @default(100)
  dtesUsedThisMonth Int     @default(0)
  monthResetDate  DateTime?

  // Notas admin
  adminNotes      String?   @db.NVarChar(Max)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  usuarios        User[]
  dtes            DTE[]
  clientes        Cliente[]

  // Email & Onboarding relations
  emailConfig        TenantEmailConfig?
  emailConfigRequests EmailConfigRequest[]
  onboarding         TenantOnboarding?

  // Support tickets relation
  supportTickets     SupportTicket[]

  // Hacienda configuration
  haciendaConfig     HaciendaConfig?
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  password            String
  nombre              String
  rol                 String    @default("FACTURADOR")
  tenantId            String?
  tenant              Tenant?   @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdAt           DateTime  @default(now())
  failedLoginAttempts Int       @default(0)
  accountLockedUntil  DateTime?
  lastFailedLoginAt   DateTime?

  // Support tickets relations
  assignedTickets   SupportTicket[]   @relation("AssignedTickets")
  requestedTickets  SupportTicket[]   @relation("RequestedTickets")
  ticketComments    TicketComment[]   @relation("TicketComments")
  ticketActivities  TicketActivity[]  @relation("TicketActivities")

  @@index([tenantId])
}

model Cliente {
  id            String  @id @default(cuid())
  tenantId      String
  tenant        Tenant  @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tipoDocumento String
  numDocumento  String
  nombre        String
  nrc           String?
  correo        String?
  telefono      String?
  direccion     String  @db.NVarChar(Max)
  dtes          DTE[]

  @@unique([tenantId, numDocumento])
  @@index([tenantId])
}

model DTE {
  id               String    @id @default(cuid())
  tenantId         String
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  clienteId        String?
  cliente          Cliente?  @relation(fields: [clienteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tipoDte          String
  codigoGeneracion String    @unique
  numeroControl    String    @unique
  jsonOriginal     String    @db.NVarChar(Max)
  jsonFirmado      String?   @db.NVarChar(Max)
  estado           String    @default("PENDIENTE")
  selloRecepcion   String?
  fechaRecepcion   DateTime?
  codigoMh         String?
  descripcionMh    String?   @db.NVarChar(Max)
  totalGravada     Decimal   @db.Decimal(12, 2)
  totalIva         Decimal   @db.Decimal(12, 2)
  totalPagar       Decimal   @db.Decimal(12, 2)
  intentosEnvio    Int       @default(0)
  createdAt        DateTime  @default(now())
  logs             DTELog[]

  @@index([tenantId])
  @@index([estado])
  @@index([createdAt])
}

model DTELog {
  id        String   @id @default(cuid())
  dteId     String
  dte       DTE      @relation(fields: [dteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  accion    String
  request   String?  @db.NVarChar(Max)
  response  String?  @db.NVarChar(Max)
  error     String?  @db.NVarChar(Max)
  createdAt DateTime @default(now())

  @@index([dteId])
}

// ============================================================================
// EMAIL CONFIGURATION SYSTEM
// ============================================================================

// EmailProvider: SENDGRID, MAILGUN, AMAZON_SES, MICROSOFT_365, GOOGLE_WORKSPACE, POSTMARK, BREVO, MAILTRAP, SMTP_GENERIC
// EmailAuthMethod: API_KEY, SMTP_BASIC, OAUTH2, AWS_IAM
// ConfiguredBy: SELF, REPUBLICODE, PENDING
// HealthCheckType: CONNECTION_TEST, AUTHENTICATION_TEST, SEND_TEST, QUOTA_CHECK, OAUTH_REFRESH
// HealthStatus: HEALTHY, DEGRADED, UNHEALTHY, UNKNOWN
// EmailSendStatus: PENDING, SENT, DELIVERED, OPENED, BOUNCED, FAILED, SPAM_REPORTED
// EmailRequestType: NEW_SETUP, MIGRATION, CONFIGURATION_HELP, TROUBLESHOOTING
// RequestStatus: PENDING, IN_PROGRESS, WAITING_CLIENT, COMPLETED, CANCELLED
// MessageSender: TENANT, REPUBLICODE, SYSTEM

// Configuración principal de email del tenant
model TenantEmailConfig {
  id                String          @id @default(cuid())
  tenantId          String          @unique
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Proveedor y método
  provider          String          // EmailProvider
  authMethod        String          // EmailAuthMethod
  isActive          Boolean         @default(false)
  isVerified        Boolean         @default(false)

  // Configuración SMTP (encriptada)
  smtpHost          String?
  smtpPort          Int?
  smtpSecure        Boolean?        @default(true)
  smtpUser          String?
  smtpPassword      String?         @db.NVarChar(Max) // Encriptado en BD

  // Configuración API (encriptada)
  apiKey            String?         @db.NVarChar(Max) // Encriptado
  apiSecret         String?         @db.NVarChar(Max) // Encriptado
  apiEndpoint       String?

  // OAuth2 (para M365 y Google)
  oauth2ClientId     String?
  oauth2ClientSecret String?        @db.NVarChar(Max) // Encriptado
  oauth2TenantId     String?        // Para Azure AD
  oauth2RefreshToken String?        @db.NVarChar(Max) // Encriptado
  oauth2AccessToken  String?        @db.NVarChar(Max) // Encriptado
  oauth2TokenExpiry  DateTime?

  // Configuración de envío
  fromEmail         String
  fromName          String
  replyToEmail      String?

  // Configuración avanzada
  rateLimitPerHour  Int?            @default(100)
  retryAttempts     Int?            @default(3)
  timeoutSeconds    Int?            @default(30)

  // Metadatos
  configuredBy      String          @default("PENDING") // ConfiguredBy
  configuredByUserId String?
  notes             String?         @db.NVarChar(Max)

  // Auditoría
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  verifiedAt        DateTime?
  lastTestAt        DateTime?

  // Relaciones
  healthChecks      EmailHealthCheck[]
  sendLogs          EmailSendLog[]

  @@index([tenantId])
}

// Monitoreo de salud del servicio de email
model EmailHealthCheck {
  id              String            @id @default(cuid())
  configId        String
  config          TenantEmailConfig @relation(fields: [configId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  checkType       String            // HealthCheckType
  status          String            // HealthStatus
  responseTimeMs  Int?
  errorMessage    String?           @db.NVarChar(Max)
  errorCode       String?

  checkedAt       DateTime          @default(now())

  @@index([configId, checkedAt])
}

// Log de envíos de email
model EmailSendLog {
  id                String            @id @default(cuid())
  configId          String
  config            TenantEmailConfig @relation(fields: [configId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  dteId             String?           // Referencia al DTE enviado
  recipientEmail    String
  subject           String

  status            String            // EmailSendStatus
  providerMessageId String?
  errorMessage      String?           @db.NVarChar(Max)

  attemptNumber     Int               @default(1)
  sentAt            DateTime          @default(now())
  deliveredAt       DateTime?
  openedAt          DateTime?

  @@index([configId, sentAt])
  @@index([dteId])
}

// Solicitudes de servicio asistido
model EmailConfigRequest {
  id                String           @id @default(cuid())
  tenantId          String
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  requestType       String           // EmailRequestType
  desiredProvider   String?          // EmailProvider

  // Información proporcionada por el cliente
  currentProvider   String?
  accountEmail      String?
  additionalNotes   String?          @db.NVarChar(Max)

  // Estado del proceso
  status            String           @default("PENDING") // RequestStatus
  assignedTo        String?

  // Comunicación
  messages          EmailConfigMessage[]

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  completedAt       DateTime?

  @@index([tenantId])
  @@index([status])
}

model EmailConfigMessage {
  id              String             @id @default(cuid())
  requestId       String
  request         EmailConfigRequest @relation(fields: [requestId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  senderType      String             // MessageSender
  senderId        String?
  message         String             @db.NVarChar(Max)
  attachments     String?            @db.NVarChar(Max) // JSON array de URLs

  createdAt       DateTime           @default(now())

  @@index([requestId])
}

// ============================================================================
// ONBOARDING WIZARD SYSTEM - PROCESO DE REGISTRO CON HACIENDA
// ============================================================================

// OnboardingStep: WELCOME, COMPANY_INFO, HACIENDA_CREDENTIALS, DTE_TYPE_SELECTION, TEST_ENVIRONMENT_REQUEST, TEST_CERTIFICATE, API_CREDENTIALS_TEST, EXECUTE_TESTS, REQUEST_AUTHORIZATION, PROD_CERTIFICATE, API_CREDENTIALS_PROD, FINAL_VALIDATION, COMPLETED
// OnboardingStatus: NOT_STARTED, IN_PROGRESS, WAITING_HACIENDA, WAITING_CLIENT, BLOCKED, COMPLETED, CANCELLED
// AssistanceLevel: SELF_SERVICE, GUIDED, FULL_SERVICE
// DteType: FACTURA, CREDITO_FISCAL, NOTA_REMISION, NOTA_CREDITO, NOTA_DEBITO, COMPROBANTE_RETENCION, COMPROBANTE_LIQUIDACION, DOCUMENTO_CONTABLE_LIQUIDACION, FACTURA_EXPORTACION, FACTURA_SUJETO_EXCLUIDO, COMPROBANTE_DONACION
// StepStatus: PENDING, IN_PROGRESS, COMPLETED, SKIPPED, BLOCKED, FAILED
// PerformedBy: TENANT, REPUBLICODE, SYSTEM
// TestResult: SUCCESS, VALIDATION_ERROR, SIGNATURE_ERROR, TRANSMISSION_ERROR, OTHER_ERROR
// CommunicationType: EMAIL, IN_APP_MESSAGE, PHONE_CALL_LOG, MEETING_NOTES, SYSTEM_NOTIFICATION
// CommunicationDirection: TO_TENANT, FROM_TENANT, INTERNAL

// Proceso de onboarding del tenant
model TenantOnboarding {
  id                  String            @id @default(cuid())
  tenantId            String            @unique
  tenant              Tenant            @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Estado general
  currentStep         String            @default("WELCOME") // OnboardingStep
  overallStatus       String            @default("NOT_STARTED") // OnboardingStatus

  // Información del contribuyente (puede diferir del Tenant base)
  nit                 String?
  nrc                 String?
  razonSocial         String?
  nombreComercial     String?
  actividadEconomica  String?

  // Información de contacto Hacienda
  emailHacienda       String?           // Email registrado en Hacienda
  telefonoHacienda    String?

  // Credenciales MH (encriptadas)
  haciendaUser        String?
  haciendaPassword    String?           @db.NVarChar(Max) // Encriptado

  // Ambiente de pruebas
  testCertificate     String?           @db.NVarChar(Max) // Certificado de pruebas (base64)
  testCertPassword    String?           @db.NVarChar(Max) // Encriptado
  testCertExpiry      DateTime?
  testApiPassword     String?           @db.NVarChar(Max) // Encriptado
  testEnvironmentUrl  String?

  // Ambiente productivo
  prodCertificate     String?           @db.NVarChar(Max) // Certificado productivo (base64)
  prodCertPassword    String?           @db.NVarChar(Max) // Encriptado
  prodCertExpiry      DateTime?
  prodApiPassword     String?           @db.NVarChar(Max) // Encriptado
  prodEnvironmentUrl  String?

  // Fechas clave
  testAccessGrantedAt DateTime?
  testDeadline        DateTime?         // 60 días desde acceso
  authorizationDate   DateTime?
  productionDeadline  DateTime?         // 30 días desde autorización

  // Servicio asistido
  assistanceLevel     String            @default("GUIDED") // AssistanceLevel
  assignedAgent       String?

  // Auditoría
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  completedAt         DateTime?

  // Relaciones
  dteTypes            DteTypeSelection[]
  steps               OnboardingStepRecord[]
  testProgress        TestProgress?
  communications      OnboardingCommunication[]

  @@index([tenantId])
  @@index([currentStep])
  @@index([overallStatus])
}

// Tipos de DTE que el tenant quiere emitir
model DteTypeSelection {
  id              String           @id @default(cuid())
  onboardingId    String
  onboarding      TenantOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  dteType         String           // DteType
  isRequired      Boolean          @default(true)   // Algunos son obligatorios
  testCompleted   Boolean          @default(false)
  testCompletedAt DateTime?

  @@unique([onboardingId, dteType])
  @@index([onboardingId])
}

// Registro detallado de cada paso
model OnboardingStepRecord {
  id              String           @id @default(cuid())
  onboardingId    String
  onboarding      TenantOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  step            String           // OnboardingStep
  status          String           @default("PENDING") // StepStatus

  // Datos específicos del paso (JSON)
  stepData        String?          @db.NVarChar(Max) // JSON data

  // Notas y observaciones
  notes           String?          @db.NVarChar(Max)
  blockerReason   String?          @db.NVarChar(Max)

  // Quién realizó la acción
  performedBy     String?          // PerformedBy
  performedById   String?

  // Fechas
  startedAt       DateTime?
  completedAt     DateTime?

  @@unique([onboardingId, step])
  @@index([onboardingId])
}

// Progreso de pruebas técnicas
model TestProgress {
  id              String           @id @default(cuid())
  onboardingId    String           @unique
  onboarding      TenantOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Contadores de pruebas por tipo de DTE (JSON)
  testsRequired   String           @db.NVarChar(Max) // { "FACTURA": 5, "CREDITO_FISCAL": 3, ... }
  testsCompleted  String           @db.NVarChar(Max) // { "FACTURA": 5, "CREDITO_FISCAL": 2, ... }

  // Eventos requeridos (JSON)
  eventsRequired  String           @db.NVarChar(Max) // { "ANULACION": 2, "CONTINGENCIA": 1, ... }
  eventsCompleted String           @db.NVarChar(Max)

  lastTestAt      DateTime?
  lastTestResult  String?          // TestResult
  lastTestError   String?          @db.NVarChar(Max)

  @@index([onboardingId])
}

// Comunicaciones durante el onboarding
model OnboardingCommunication {
  id              String                 @id @default(cuid())
  onboardingId    String
  onboarding      TenantOnboarding       @relation(fields: [onboardingId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  type            String                 // CommunicationType
  direction       String                 // CommunicationDirection
  subject         String?
  content         String                 @db.NVarChar(Max)
  attachments     String?                @db.NVarChar(Max) // JSON array de URLs

  relatedStep     String?                // OnboardingStep

  sentBy          String?
  sentAt          DateTime               @default(now())
  readAt          DateTime?

  @@index([onboardingId])
}

// ============================================================================
// SISTEMA DE TICKETS DE SOPORTE
// ============================================================================

// TicketType: EMAIL_CONFIG, TECHNICAL, BILLING, GENERAL, ONBOARDING
// TicketStatus: PENDING, ASSIGNED, IN_PROGRESS, WAITING_CUSTOMER, RESOLVED, CLOSED
// TicketPriority: LOW, MEDIUM, HIGH, URGENT
// TicketAction: CREATED, STATUS_CHANGED, ASSIGNED, PRIORITY_CHANGED, COMMENT_ADDED, RESOLVED, CLOSED

model SupportTicket {
  id            String    @id @default(cuid())
  ticketNumber  String    @unique // Formato: TKT-YYYYMMDD-XXXX

  // Relacion con tenant
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Informacion del ticket
  type          String    // EMAIL_CONFIG, TECHNICAL, BILLING, GENERAL, ONBOARDING
  subject       String    @db.NVarChar(255)
  description   String?   @db.NVarChar(Max)

  // Estado y prioridad
  status        String    @default("PENDING") // PENDING, ASSIGNED, IN_PROGRESS, WAITING_CUSTOMER, RESOLVED, CLOSED
  priority      String    @default("MEDIUM")  // LOW, MEDIUM, HIGH, URGENT

  // Asignacion
  assignedToId  String?
  assignedTo    User?     @relation("AssignedTickets", fields: [assignedToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  assignedAt    DateTime?

  // Solicitante
  requesterId   String
  requester     User      @relation("RequestedTickets", fields: [requesterId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Metadatos (JSON con datos del formulario de ayuda)
  metadata      String?   @db.NVarChar(Max)

  // Resolucion
  resolution    String?   @db.NVarChar(Max)
  resolvedAt    DateTime?

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  comments      TicketComment[]
  activities    TicketActivity[]

  @@index([tenantId])
  @@index([status])
  @@index([assignedToId])
  @@index([createdAt])
}

model TicketComment {
  id          String        @id @default(cuid())
  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  authorId    String
  author      User          @relation("TicketComments", fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  content     String        @db.NVarChar(Max)
  isInternal  Boolean       @default(false) // Solo visible para admins

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([ticketId])
}

model TicketActivity {
  id          String        @id @default(cuid())
  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  actorId     String
  actor       User          @relation("TicketActivities", fields: [actorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  action      String   // CREATED, STATUS_CHANGED, ASSIGNED, PRIORITY_CHANGED, COMMENT_ADDED, RESOLVED, CLOSED
  oldValue    String?
  newValue    String?

  createdAt   DateTime @default(now())

  @@index([ticketId])
}

// ============================================================================
// GESTION DE CATALOGOS DEL MINISTERIO DE HACIENDA
// ============================================================================

model Catalogo {
  id            String         @id @default(cuid())
  codigo        String         @unique // CAT-002, CAT-013, etc.
  nombre        String         @db.NVarChar(255)
  descripcion   String?        @db.NVarChar(500)
  version       String         @default("1.0")
  totalItems    Int            @default(0)
  lastSyncAt    DateTime?
  isActive      Boolean        @default(true)

  items         CatalogoItem[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model CatalogoItem {
  id            String    @id @default(cuid())
  catalogoId    String
  catalogo      Catalogo  @relation(fields: [catalogoId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  codigo        String
  valor         String    @db.NVarChar(255)
  descripcion   String?   @db.NVarChar(500)
  parentCodigo  String?   // Para municipios (codigo del departamento padre)
  orden         Int       @default(0)
  isActive      Boolean   @default(true)

  metadata      String?   @db.NVarChar(Max) // JSON para datos adicionales

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([catalogoId, codigo])
  @@index([catalogoId])
  @@index([parentCodigo])
}

// ============================================================================
// PLANES Y LIMITES
// ============================================================================

model Plan {
  id              String    @id @default(cuid())
  codigo          String    @unique // DEMO, TRIAL, BASIC, PRO, ENTERPRISE
  nombre          String    @db.NVarChar(100)
  descripcion     String?   @db.NVarChar(500)

  // Limites
  maxDtesPerMonth Int       @default(100)   // -1 para ilimitado
  maxUsers        Int       @default(1)     // -1 para ilimitado
  maxClientes     Int       @default(100)   // -1 para ilimitado
  maxStorageMb    Int       @default(500)   // -1 para ilimitado

  // Features habilitados (JSON array)
  features        String?   @db.NVarChar(Max)

  // Precios (referencia)
  precioMensual   Decimal?  @db.Decimal(10, 2)
  precioAnual     Decimal?  @db.Decimal(10, 2)

  isActive        Boolean   @default(true)
  isDefault       Boolean   @default(false) // Plan por defecto para nuevos tenants
  orden           Int       @default(0) // Para ordenar en UI

  tenants         Tenant[]  @relation("TenantPlan")

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ============================================================================
// SISTEMA DE NOTIFICACIONES
// ============================================================================

// NotificationType: SYSTEM_ANNOUNCEMENT, MAINTENANCE, NEW_FEATURE, PLAN_LIMIT_WARNING, PLAN_EXPIRED, SECURITY_ALERT, GENERAL
// NotificationPriority: LOW, MEDIUM, HIGH, URGENT
// NotificationTarget: ALL_USERS, ALL_TENANTS, SPECIFIC_TENANT, SPECIFIC_USER, BY_PLAN

model SystemNotification {
  id              String    @id @default(cuid())

  // Contenido
  title           String    @db.NVarChar(255)
  message         String    @db.NVarChar(Max)
  type            String    @default("GENERAL") // NotificationType
  priority        String    @default("MEDIUM")  // NotificationPriority

  // Targeting
  target          String    @default("ALL_USERS") // NotificationTarget
  targetTenantId  String?   // Si target = SPECIFIC_TENANT
  targetUserId    String?   // Si target = SPECIFIC_USER
  targetPlanIds   String?   // JSON array de plan IDs si target = BY_PLAN

  // Programacion
  startsAt        DateTime  @default(now())
  expiresAt       DateTime?

  // Comportamiento
  isDismissable   Boolean   @default(true)
  showOnce        Boolean   @default(false) // Solo mostrar una vez por usuario
  actionUrl       String?   // URL opcional para redirigir
  actionLabel     String?   @db.NVarChar(100) // Texto del boton de accion

  // Metadata
  createdById     String?
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relaciones
  dismissals      NotificationDismissal[]

  @@index([isActive, startsAt])
  @@index([target])
}

model NotificationDismissal {
  id              String             @id @default(cuid())
  notificationId  String
  notification    SystemNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  userId          String
  dismissedAt     DateTime           @default(now())

  @@unique([notificationId, userId])
  @@index([userId])
}

// ============================================================================
// SISTEMA DE LOGS Y AUDITORIA
// ============================================================================

// AuditAction: LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, IMPORT, UPLOAD, DOWNLOAD, SEND, SIGN, TRANSMIT, CONFIG_CHANGE
// AuditModule: AUTH, TENANT, USER, DTE, CLIENTE, CERTIFICATE, EMAIL_CONFIG, SETTINGS, SUPPORT, ADMIN

model AuditLog {
  id            String    @id @default(cuid())

  // Quien realizo la accion
  userId        String?
  userEmail     String?   @db.NVarChar(255)
  userName      String?   @db.NVarChar(255)
  userRole      String?   @db.NVarChar(50)

  // Contexto del tenant
  tenantId      String?
  tenantNombre  String?   @db.NVarChar(255)

  // Detalles de la accion
  action        String    @db.NVarChar(50)  // AuditAction
  module        String    @db.NVarChar(50)  // AuditModule
  description   String    @db.NVarChar(500)

  // Entidad afectada
  entityType    String?   @db.NVarChar(100) // Tipo de entidad (ej: DTE, Cliente, User)
  entityId      String?   // ID de la entidad afectada

  // Datos adicionales
  oldValue      String?   @db.NVarChar(Max) // JSON con valor anterior
  newValue      String?   @db.NVarChar(Max) // JSON con valor nuevo
  metadata      String?   @db.NVarChar(Max) // JSON con datos adicionales

  // Informacion de la peticion
  ipAddress     String?   @db.NVarChar(50)
  userAgent     String?   @db.NVarChar(500)
  requestPath   String?   @db.NVarChar(500)
  requestMethod String?   @db.NVarChar(10)

  // Resultado
  success       Boolean   @default(true)
  errorMessage  String?   @db.NVarChar(Max)

  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([tenantId])
  @@index([action])
  @@index([module])
  @@index([createdAt])
  @@index([entityType, entityId])
}

// ============================================================================
// HACIENDA CONFIGURATION SYSTEM - ROBUST MH INTEGRATION
// ============================================================================

// HaciendaEnvironment: TEST, PRODUCTION
// TestingStatus: NOT_STARTED, IN_PROGRESS, PENDING_AUTHORIZATION, AUTHORIZED
// HaciendaTestType: EMISSION, CANCELLATION, CONTINGENCY
// HaciendaTestStatus: PENDING, SUCCESS, FAILED

// Configuración principal de Hacienda por Tenant
model HaciendaConfig {
  id                      String              @id @default(cuid())
  tenantId                String              @unique
  tenant                  Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Ambiente activo para emisión
  activeEnvironment       String              @default("TEST") // HaciendaEnvironment

  // Estado del proceso de acreditación
  testingStatus           String              @default("NOT_STARTED") // TestingStatus
  testingStartedAt        DateTime?
  testingCompletedAt      DateTime?
  productionAuthorizedAt  DateTime?

  // Relaciones
  environmentConfigs      HaciendaEnvironmentConfig[]
  testRecords             HaciendaTestRecord[]

  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  @@index([tenantId])
}

// Configuración por ambiente (TEST o PRODUCTION)
model HaciendaEnvironmentConfig {
  id                      String              @id @default(cuid())

  haciendaConfigId        String
  haciendaConfig          HaciendaConfig      @relation(fields: [haciendaConfigId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  environment             String              // HaciendaEnvironment: TEST | PRODUCTION

  // === CREDENCIALES API ===
  apiUser                 String?
  apiPasswordEncrypted    String?             @db.NVarChar(500)

  // === CERTIFICADO DIGITAL ===
  certificateP12          Bytes?              @db.VarBinary(Max)
  certificateFileName     String?
  certificatePasswordEnc  String?             @db.NVarChar(500)
  certificateValidUntil   DateTime?
  certificateNit          String?
  certificateSubject      String?             @db.NVarChar(500)

  // === TOKEN ACTUAL ===
  currentTokenEncrypted   String?             @db.NVarChar(Max)
  tokenExpiresAt          DateTime?
  tokenRefreshedAt        DateTime?

  // === ESTADO ===
  isConfigured            Boolean             @default(false)
  isValidated             Boolean             @default(false)
  lastValidationAt        DateTime?
  lastValidationError     String?             @db.NVarChar(500)

  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  @@unique([haciendaConfigId, environment])
  @@index([haciendaConfigId])
}

// Registro de pruebas ejecutadas
model HaciendaTestRecord {
  id                      String              @id @default(cuid())

  haciendaConfigId        String
  haciendaConfig          HaciendaConfig      @relation(fields: [haciendaConfigId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Tipo de prueba
  dteType                 String              // 01, 03, 04, 05, 06, 11, 14
  testType                String              // HaciendaTestType: EMISSION, CANCELLATION, CONTINGENCY

  // Resultado
  status                  String              // HaciendaTestStatus: PENDING, SUCCESS, FAILED
  codigoGeneracion        String?
  selloRecibido           String?

  // Detalles para debugging
  requestPayload          String?             @db.NVarChar(Max)
  responsePayload         String?             @db.NVarChar(Max)
  errorMessage            String?             @db.NVarChar(500)

  executedAt              DateTime            @default(now())

  @@index([haciendaConfigId, dteType])
  @@index([haciendaConfigId, status])
}
