# üìã Session Summary: 2026-02-09 ‚Äî Production Bug Fixes & Stabilization

## üéØ Objective
Fix critical production bugs blocking the web app (crashes, infinite loops, missing endpoints) and complete Sprint 1 (Pagination) & Sprint 2 (Recurring Invoices) deployment.

## ‚úÖ What We Accomplished

### 1. Fixed Infinite Retry Loop (CRITICAL)
- **Root Cause**: `toast` from `useToast()` in `useCallback` dependency arrays. When a fetch failed, `toast.error()` changed toasts state, which recreated the callback, which re-triggered the useEffect ‚Äî infinite loop (3,129+ requests observed).
- **Fix**: Replaced `toast` in deps with `toastRef` pattern (stable ref). Added 404-specific handling that sets error state without toasting.
- **Files**: 5 files (recurrentes pages, hacienda config, toast provider)

### 2. Fixed Application Crashes from Missing API Endpoints
- **Root Cause**: API v16 doesn't have `/recurring-invoices` or `/plans/my-usage` endpoints. Frontend called them without error handling ‚Üí `TypeError: Cannot read properties of undefined`
- **Fix**: Added `safeFetch()` wrapper, `.json().catch(() => ({}))` on all error paths, `Array.isArray()` guards, null checks on `.length`/`.map`/`.filter`
- **Files**: 19 files across all dashboard pages, components, auth pages

### 3. Fixed Clientes Page Data Parsing
- **Root Cause**: `setClientes(data.data)` ‚Äî if API response shape is unexpected, `data.data` is undefined, then `clientes.length` crashes
- **Fix**: Defensive parsing: `Array.isArray(data?.data) ? data.data : Array.isArray(data) ? data : []`
- **Files**: clientes/page.tsx

### 4. Fixed Pagination (Backend + Frontend)
- **Root Cause**: Query params arrived as strings to Prisma service, causing `take`/`skip` to malfunction. Frontend pagination component returned `null` when `totalPages <= 1`.
- **Fix**: Backend: `Number()` conversion with `Math.max/Math.min` clamping. Frontend: Always show info bar, conditionally show page buttons.
- **Files**: clientes.service.ts, recurring-invoices.service.ts, clientes/page.tsx, pagination.tsx

### 5. Fixed Tenant Name Not Displaying
- **Root Cause**: Frontend called `/tenants/current` but API only has `@Get('me')`. Request fell through to `@Get(':id')` with id="current", returning null.
- **Fix**: Changed endpoint from `/tenants/current` to `/tenants/me`
- **Files**: layout.tsx

### 6. Fixed "Mostrar X" Filter
- **Root Cause**: Overly strict `typeof === 'number'` check for totalPages
- **Fix**: `Number()` parsing with `isNaN()` checks
- **Files**: clientes/page.tsx

### 7. Added Form Validations
- NIT format: `0000-000000-000-0`
- DUI format: `00000000-0`
- NRC: numeric, max 7 digits
- Phone: 8 digits `0000-0000`
- Email: standard validation
- Inline error messages in Spanish
- **Files**: clientes/page.tsx, configuracion/page.tsx

### 8. Recurring Invoices Graceful Degradation
- Hide "Nuevo Template" button when API unavailable
- Show unavailable message on `/recurrentes/nuevo` when API returns 404
- **Files**: recurrentes/page.tsx, recurrentes/nuevo/page.tsx

## üìä Deployment History This Session

| Version | Type | Status | Changes |
|---------|------|--------|---------|
| Web v21 | Web | ‚ùå Failed | Auth loading gates (still crashed) |
| Web v22 | Web | ‚ö†Ô∏è Partial | Fixed infinite loop, but /plans/my-usage crash |
| Web v23 | Web | ‚ö†Ô∏è Partial | Fixed 404 handling (19 files), but clientes .length crash |
| Web v24 | Web | ‚úÖ Working | Fixed clientes data parsing |
| Web v25 | Web | ‚úÖ Working | Pagination UI, tenant name, mostrar filter |
| API v17 | API | ‚úÖ Working | Pagination backend fix (Number conversion) |
| Web v26 | Web | ‚úÖ Working | Form validations, recurring hide, all fixes |

**Current Production**: API v17, Web v26

## üí° Lessons Learned

### 1. React useCallback + Toast = Infinite Loop
**Pattern**: Never put `toast` or any function from a context that changes on every render into useCallback/useEffect dependency arrays. Use a ref instead:
```typescript
const toastRef = useRef(toast);
toastRef.current = toast;
// In useCallback: toastRef.current.error("...") ‚Äî no dependency needed
```

### 2. Always Handle 404 as "Endpoint Not Available"
**Pattern**: Every fetch in a SaaS app must handle 404 gracefully because endpoints may not exist in all API versions:
```typescript
if (!response.ok) {
  if (response.status === 404) {
    return { data: [], total: 0 }; // Graceful empty state
  }
  const error = await response.json().catch(() => ({}));
  throw new Error(error.message || 'Request failed');
}
```

### 3. Defensive API Response Parsing
**Pattern**: Never trust the API response shape. Always validate:
```typescript
const items = Array.isArray(data?.data) ? data.data : Array.isArray(data) ? data : [];
const total = typeof data?.total === 'number' ? data.total : items.length;
```

### 4. Query Params Are Strings
**Pattern**: URL query parameters arrive as strings. Always convert before using with ORMs:
```typescript
const page = Math.max(1, Number(queryPage) || 1);
const limit = Math.min(100, Math.max(1, Number(queryLimit) || 20));
```

### 5. Deploy API Before Web When Both Change
**Pattern**: If backend and frontend both change, deploy API first and wait for it to be ready before deploying web. Web depends on API being available.

### 6. Test in Incognito After Every Deploy
**Pattern**: Browser cache is persistent. Always verify in incognito + different browser. Azure deployments take ~2 min to propagate.

### 7. Audit All Shared Components When Fixing Crashes
**Pattern**: A crash in layout/sidebar/header affects ALL pages. When fixing crash bugs, audit every fetch call in every shared component, not just the one that's visibly broken.

## üèóÔ∏è Infrastructure Reference

| Resource | Value |
|----------|-------|
| Resource Group | facturador-sv-rg |
| API App Service | facturador-api-sv |
| Web App Service | facturador-web-sv |
| Container Registry | facturadorsvacr |
| SQL Server | facturador-sql-sv.database.windows.net |
| Database | facturadordb |
| API URL | https://facturador-api-sv-gvavh8heb5c5gkc9.eastus2-01.azurewebsites.net |
| Web URL | https://facturador-web-sv-chayeth5a0h2abcf.eastus2-01.azurewebsites.net |
